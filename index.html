<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GTM Playground</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
    }
    input, button, textarea {
      font-size: 16px;
      margin: 5px 0;
    }
    input {
      padding: 8px;
      width: 300px;
    }
    button {
      padding: 10px 16px;
      cursor: pointer;
    }
    textarea {
      width: 100%;
      font-family: monospace;
      resize: none;
      overflow: auto;
      background: #f9f9f9;
    }
    .preset-wrapper {
      margin-bottom: 30px;
    }
    .preset-columns {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .preset-box {
      flex: 1;
      min-width: 400px;
    }
    .log {
      margin-top: 15px;
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ddd;
      font-family: monospace;
    }
    hr {
      margin: 30px 0;
    }
    .event-label {
      color: #1a0dab;
      font-weight: bold;
    }
    .copy-button {
      margin-left: 8px;
    }
  </style>
</head>
<body>

  <h1>GTM Playground</h1>

  <label for="gtmId">Enter your GTM Container ID:</label><br>
  <input type="text" id="gtmId" placeholder="GTM-XXXXXXX" />
  <button onclick="loadGTM()">Inject GTM</button>
  <div id="status"></div>

  <hr>

  <h3>Free custom JS</h3>
  <textarea id="customJson" rows="6">// Example:
dataLayer.push({
  event: "custom_event",
  my_value: 123
});</textarea>
  <br>
  <button onclick="runCustom()">Run JS</button>
  <button onclick="copyToClipboard('customJson')">Copy</button>

  <div class="log" id="logOutput">Console output will appear hereâ€¦</div>

  <hr>

  <h3>Quick test events (editable presets from <code>datalayer.js</code>)</h3>
  <div id="presetsArea"></div>
  <button onclick="savePresets()">ðŸ’¾ Save All</button>

  <script src="datalayer.js"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function loadGTM() {
      const id = document.getElementById('gtmId').value.trim();
      if (!id.match(/^GTM-[A-Z0-9]+$/i)) {
        alert('Invalid GTM ID');
        return;
      }

      localStorage.setItem('gtm_id', id);

      const script = document.createElement('script');
      script.src = 'https://www.googletagmanager.com/gtm.js?id=' + id;
      script.async = true;
      document.head.appendChild(script);

      dataLayer.push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });

      const iframe = document.createElement('iframe');
      iframe.src = `https://www.googletagmanager.com/ns.html?id=${id}`;
      iframe.height = 0;
      iframe.width = 0;
      iframe.style.display = 'none';
      iframe.style.visibility = 'hidden';
      document.body.appendChild(iframe);

      document.getElementById('status').textContent = `âœ… GTM container ${id} injected`;
    }

    function runCustom() {
      try {
        const raw = document.getElementById('customJson').value;
        new Function(raw)();
        log('âœ… Ran custom JS');
      } catch (e) {
        log('âŒ Error: ' + e.message);
      }
    }

    function copyToClipboard(id) {
      const el = document.getElementById(id);
      el.select();
      document.execCommand('copy');
      log('ðŸ“‹ Copied to clipboard');
    }

    function log(msg) {
      document.getElementById('logOutput').textContent = msg;
      console.log(msg);
    }

    const defaultPresets = window.gtmPresets || [];

    function extractEventName(jsCode) {
      const match = jsCode.match(/['"]event['"]\s*:\s*['"](.*?)['"]/) || [];
      return match[1] || 'custom';
    }

    function autoIndent(code) {
      try {
        const pretty = code
          .replace(/([,{])/g, '$1\n')
          .replace(/}/g, '\n}')
          .replace(/;/g, ';\n')
          .replace(/\n\n+/g, '\n')
          .replace(/\n /g, '\n');
        return pretty.trim();
      } catch {
        return code;
      }
    }

    function loadPresets() {
      const saved = localStorage.getItem('presets_full_js');
      const presets = saved ? JSON.parse(saved) : defaultPresets;

      const container = document.getElementById('presetsArea');
      container.innerHTML = '';

      const first = presets[0];
      const rest = presets.slice(1);

      if (first) container.appendChild(renderPreset(first, 0, false));

      const row = document.createElement('div');
      row.className = 'preset-columns';

      rest.forEach((preset, i) => {
        const box = renderPreset(preset, i + 1, true);
        row.appendChild(box);
      });

      container.appendChild(row);
    }

    function renderPreset(preset, index, shrink) {
      const wrapper = document.createElement('div');
      wrapper.className = shrink ? 'preset-box' : 'preset-wrapper';

      const eventName = extractEventName(preset.code);

      const label = document.createElement('div');
      label.innerHTML = `Event: <span class="event-label">${eventName}</span>`;

      const textarea = document.createElement('textarea');
      textarea.className = 'preset';
      textarea.dataset.index = index;
      textarea.value = autoIndent(preset.code);
      textarea.rows = shrink ? (textarea.value.split('\n').length + 1) : 18;

      const runBtn = document.createElement('button');
      runBtn.textContent = `Push: ${eventName}`;
      runBtn.onclick = function () {
        try {
          new Function(textarea.value)();
          log(`âœ… Executed: ${eventName}`);
        } catch (e) {
          log('âŒ Error parsing JS: ' + e.message);
        }
      };

      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'Copy';
      copyBtn.className = 'copy-button';
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(textarea.value);
        log('ðŸ“‹ Copied event to clipboard');
      };

      wrapper.appendChild(label);
      wrapper.appendChild(textarea);
      wrapper.appendChild(document.createElement('br'));
      wrapper.appendChild(runBtn);
      wrapper.appendChild(copyBtn);
      return wrapper;
    }

    function savePresets() {
      const all = document.querySelectorAll('.preset');
      const updated = Array.from(all).map((el, i) => ({
        name: `custom_${i + 1}`,
        code: el.value
      }));
      localStorage.setItem('presets_full_js', JSON.stringify(updated));
      log('ðŸ’¾ Presets saved to localStorage');
      loadPresets();
    }

    window.addEventListener('load', () => {
      const lastId = localStorage.getItem('gtm_id');
      if (lastId) document.getElementById('gtmId').value = lastId;
      loadPresets();
    });
  </script>
</body>
</html>




