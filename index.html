<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GTM Playground</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/theme/monokai.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 15px;
    }
    .CodeMirror {
      border: 1px solid #ccc;
      font-size: 14px;
      background: #272822;
      color: #f8f8f2;
      width: 100%;
    }
    .preset-block {
      margin-bottom: 20px;
    }
    .editor-container {
      margin: 5px 0;
    }
    .editor-label {
      font-weight: bold;
    }
    textarea {
      width: 100%;
    }
    button {
      margin-right: 5px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>GTM Playground</h1>

  <label>Enter your GTM Container ID:
    <input type="text" id="gtm-id" placeholder="GTM-XXXXXXX">
    <button onclick="injectGTM()">Inject GTM</button>
  </label>

  <h2>Free custom JS</h2>
  <div class="editor-container">
    <textarea id="free-js">// Example:
dataLayer.push({
  event: "custom_event",
  my_value: 123
});</textarea>
  </div>
  <button onclick="runFreeJS()">Run JS</button>
  <button onclick="copyFreeJS()">Copy</button>
  <pre id="output">Console output will appear here…</pre>

  <h2>Test Events (editable in <code>datalayer.js</code>)</h2>
  <button onclick="saveChanges()">💾 Save Changes to localStorage</button>
  <p>Gem ændringer, så de bevares ved reload.</p>
  <button onclick="copyAll()">📄 Copy ALL as datalayer.js file</button>
  <p>Kopierer alle events i formatet klar til <code>datalayer.js</code>.</p>
  <button onclick="resetPresets()">🔄 Reset and use datalayer.js</button>
  <p>Fjerner gemte events og henter igen fra <code>datalayer.js</code></p>

  <div id="presets"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>

  <script>
    function injectGTM() {
      const id = document.getElementById("gtm-id").value.trim();
      if (!id) return alert("Please enter GTM Container ID");
      const script = document.createElement("script");
      script.src = `https://www.googletagmanager.com/gtm.js?id=${id}`;
      document.body.appendChild(script);
    }

    function runFreeJS() {
      const code = freeEditor.getValue();
      try {
        eval(code);
        document.getElementById("output").innerText = "~ ✓ Google dataLayer.push(): event ok";
      } catch (e) {
        document.getElementById("output").innerText = "~ ✗ Error: " + e.message;
      }
    }

    function copyFreeJS() {
      navigator.clipboard.writeText(freeEditor.getValue());
    }

    function saveChanges() {
      localStorage.setItem("presetEvents", JSON.stringify(window.gtmPresets));
      alert("✅ Saved to localStorage.");
    }

    function resetPresets() {
      localStorage.removeItem("presetEvents");
      location.reload();
    }

    function copyAll() {
      const output = window.gtmPresets.map(p => {
        return `// ===== START: ${p.name} =====\n{\n  name: "${p.name}",\n  code: \`${p.code}\`\n},\n// ===== END: ${p.name} =====\n`;
      }).join("\n");
      navigator.clipboard.writeText(`const presetEvents = [\n${output}];\n\nwindow.gtmPresets = presetEvents;`);
      alert("📋 Copied as datalayer.js block");
    }

    function renderPresets(presets) {
      const container = document.getElementById("presets");
      container.innerHTML = "";
      presets.forEach((preset, index) => {
        const block = document.createElement("div");
        block.className = "preset-block";

        const title = document.createElement("div");
        title.className = "editor-label";
        title.textContent = `Event: ${preset.name}`;
        block.appendChild(title);

        const ta = document.createElement("textarea");
        ta.value = preset.code;
        block.appendChild(ta);

        const cm = CodeMirror.fromTextArea(ta, {
          mode: "javascript",
          lineNumbers: true,
          theme: "monokai"
        });

        cm.on("change", () => {
          const code = cm.getValue();
          try {
            JSHINT(code);
            if (JSHINT.errors.length > 0) {
              cm.setOption("gutters", ["CodeMirror-linenumbers", "CodeMirror-lint-markers"]);
              cm.clearGutter("CodeMirror-lint-markers");
              JSHINT.errors.forEach(err => {
                if (!err) return;
                const marker = document.createElement("div");
                marker.style.color = "red";
                marker.innerHTML = "●";
                cm.setGutterMarker(err.line - 1, "CodeMirror-lint-markers", marker);
              });
            } else {
              cm.clearGutter("CodeMirror-lint-markers");
            }
          } catch (e) {}

          presets[index].code = code;
        });

        const btnPush = document.createElement("button");
        btnPush.textContent = "Push";
        btnPush.onclick = () => eval(cm.getValue());

        const btnCopyPush = document.createElement("button");
        btnCopyPush.textContent = "Copy as dataLayer.push";
        btnCopyPush.onclick = () => navigator.clipboard.writeText(cm.getValue());

        const btnCopyBlock = document.createElement("button");
        btnCopyBlock.textContent = "Copy as datalayer.js block";
        btnCopyBlock.onclick = () => {
          const text = `// ===== START: ${preset.name} =====\n{\n  name: "${preset.name}",\n  code: \`${cm.getValue()}\`\n},\n// ===== END: ${preset.name} =====`;
          navigator.clipboard.writeText(text);
        };

        block.appendChild(document.createElement("br"));
        block.appendChild(btnPush);
        block.appendChild(btnCopyPush);
        block.appendChild(btnCopyBlock);
        container.appendChild(block);
      });
    }

    function loadPresets() {
      let presets;
      try {
        const saved = JSON.parse(localStorage.getItem("presetEvents"));
        presets = Array.isArray(saved) && saved.length ? saved : window.gtmPresets;
      } catch (e) {
        presets = window.gtmPresets;
      }
      renderPresets(presets);
    }

    const freeEditor = CodeMirror.fromTextArea(document.getElementById("free-js"), {
      mode: "javascript",
      lineNumbers: true,
      theme: "monokai"
    });

    loadPresets();
  </script>

  <script src="datalayer.js"></script>
</body>
</html>


