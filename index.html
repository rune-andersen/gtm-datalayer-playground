<!-- kun den nederste del er Ã¦ndret â€“ her er hele filen for overblik -->
<script src="datalayer.js"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function loadGTM() {
    const id = document.getElementById('gtmId').value.trim();
    if (!id.match(/^GTM-[A-Z0-9]+$/i)) {
      alert('Invalid GTM ID');
      return;
    }
    localStorage.setItem('gtm_id', id);
    const script = document.createElement('script');
    script.src = 'https://www.googletagmanager.com/gtm.js?id=' + id;
    script.async = true;
    document.head.appendChild(script);
    dataLayer.push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });

    const iframe = document.createElement('iframe');
    iframe.src = `https://www.googletagmanager.com/ns.html?id=${id}`;
    iframe.height = 0;
    iframe.width = 0;
    iframe.style.display = 'none';
    iframe.style.visibility = 'hidden';
    document.body.appendChild(iframe);
  }

  function runCustom() {
    try {
      const code = customEditor.getValue();
      new Function(code)();
      log('âœ… Ran custom JS');
    } catch (e) {
      log('âŒ Error: ' + e.message);
    }
  }

  function copyCustom() {
    navigator.clipboard.writeText(customEditor.getValue()).then(() => {
      log('ðŸ“‹ Copied custom JS');
    });
  }

  function log(msg) {
    document.getElementById('logOutput').textContent = msg;
    console.log(msg);
  }

  const defaultPresets = window.gtmPresets || [];
  let presetEditors = [];
  let customEditor;

  function loadPresets() {
    const saved = localStorage.getItem('presets_full_js');
    const presets = saved ? JSON.parse(saved) : defaultPresets;
    const container = document.getElementById('presetsArea');
    container.innerHTML = '';
    presetEditors = [];

    presets.forEach((preset, i) => {
      container.appendChild(renderPreset(preset, i));
    });
  }

  function renderPreset(preset, index) {
    const wrapper = document.createElement('div');
    wrapper.className = 'preset-wrapper';

    const buttons = document.createElement('div');
    buttons.className = 'preset-buttons';

    const runBtn = document.createElement('button');
    runBtn.textContent = 'Push';

    const copyBtn = document.createElement('button');
    copyBtn.textContent = 'Copy as dataLayer.push';
    copyBtn.className = 'small-button';

    const copyDLBtn = document.createElement('button');
    copyDLBtn.textContent = 'Copy as datalayer.js block';
    copyDLBtn.className = 'small-button';

    const label = document.createElement('div');
    label.className = 'preset-header';
    label.textContent = 'Event: ' + (preset.name || `custom_${index + 1}`);

    const textarea = document.createElement('textarea');
    textarea.value = preset.code;

    const container = document.createElement('div');
    container.style.flex = '1';
    container.appendChild(label);
    container.appendChild(textarea);

    wrapper.appendChild(buttons);
    wrapper.appendChild(container);

    const editor = CodeMirror.fromTextArea(textarea, {
      mode: 'javascript',
      lineNumbers: true,
      tabSize: 2
    });

    presetEditors[index] = editor;

    runBtn.onclick = () => {
      try {
        new Function(editor.getValue())();
        log(`âœ… Executed: ${label.textContent}`);
      } catch (e) {
        log('âŒ Error parsing JS: ' + e.message);
      }
    };

    copyBtn.onclick = () => {
      navigator.clipboard.writeText(editor.getValue()).then(() => {
        log('ðŸ“‹ Copied as dataLayer.push');
      });
    };

    copyDLBtn.onclick = () => {
      const name = preset.name || `custom_${index + 1}`;
     const fullBlock = `// ***** START ${name} *****  \n{
  name: "${name}",
  code: \`${editor.getValue()}\`
},\n// ***** END ${name} *****`;

      navigator.clipboard.writeText(fullBlock).then(() => {
        log('ðŸ“‹ Copied as datalayer.js block');
      });
    };

    buttons.appendChild(runBtn);
    buttons.appendChild(copyBtn);
    buttons.appendChild(copyDLBtn);

    return wrapper;
  }

  function savePresets() {
    const updated = presetEditors.map((editor, index) => {
      const name = defaultPresets[index]?.name || `custom_${index + 1}`;
      return {
        name: name,
        code: editor.getValue()
      };
    });
    localStorage.setItem('presets_full_js', JSON.stringify(updated));
    log('ðŸ’¾ Presets saved to localStorage');
    loadPresets();
  }

  function resetPresets() {
    localStorage.removeItem('presets_full_js');
    log('â™»ï¸ LocalStorage cleared. Reloading datalayer.js presetsâ€¦');
    loadPresets();
  }

  function copyAllAsDataLayer() {
    const eventBlocks = presetEditors.map((editor, i) => {
      const name = defaultPresets[i]?.name || `custom_${i + 1}`;
      const code = editor.getValue();
      return `// ***** START ${name} *****  \n{
  name: "${name}",
  code: \\`${code}\\`
},\n// ***** END ${name} *****`;
    });
    const finalCode = `const presetEvents = [\n${eventBlocks.join('\n\n')}\n];\n\nwindow.gtmPresets = presetEvents;`;
    navigator.clipboard.writeText(finalCode).then(() => {
      log('ðŸ“‹ All events copied as datalayer.js file');
    });
  }

  // âœ… Now initializing the customEditor outside loadPresets to avoid DOM issues
  window.addEventListener('load', () => {
    const lastId = localStorage.getItem('gtm_id');
    if (lastId) document.getElementById('gtmId').value = lastId;

    customEditor = CodeMirror.fromTextArea(document.getElementById('customJson'), {
      mode: 'javascript',
      lineNumbers: true,
      tabSize: 2
    });

    loadPresets();
  });
</script>

