
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GTM Playground</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
    }
    input, button, textarea {
      font-size: 16px;
    }
    input {
      padding: 8px;
      width: 300px;
    }
    button {
      padding: 8px 12px;
      cursor: pointer;
      margin-bottom: 5px;
    }
    .preset-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 20px;
    }
    .preset-buttons {
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      margin-top: 0;
    }
    .label {
      font-weight: bold;
      margin: 30px 0 10px;
      font-size: 36px;
    }
    .log {
      margin-top: 15px;
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ddd;
      font-family: monospace;
    }
    .small-button {
      padding: 4px 8px;
      font-size: 14px;
    }
    .preset-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .CodeMirror {
      height: auto;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>GTM Playground</h1>

  <label for="gtmId">Enter your GTM Container ID:</label><br>
  <input type="text" id="gtmId" placeholder="GTM-XXXXXXX" />
  <button onclick="loadGTM()">Inject GTM</button>

  <hr>

  <div class="label">Free custom JS</div>
  <div class="preset-wrapper">
    <div class="preset-buttons">
      <button onclick="runCustom()">Run JS</button>
      <button class="small-button" onclick="copyCustom()">Copy</button>
    </div>
    <textarea id="customJson" rows="8">// Example:
dataLayer.push({event: "custom_event", my_value: 123});</textarea>
  </div>

  <div class="log" id="logOutput">Console output will appear here‚Ä¶</div>

  <hr>

  <div class="label">Test Events (editable in <code>datalayer.js</code>)</div>
  <div id="presetsArea"></div>
  <button onclick="savePresets()">üíæ Save Changes to localStorage</button>
  <button onclick="copyAllAsDataLayer()">üìã Copy ALL as datalayer.js file</button>
  <button onclick="resetPresets()">‚ôªÔ∏è Reset and use datalayer.js</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/comment/comment.min.js"></script>
  <script src="datalayer.js"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function log(msg) {
      document.getElementById('logOutput').textContent = msg;
      console.log(msg);
    }

    function loadGTM() {
      const id = document.getElementById('gtmId').value.trim();
      if (!id.match(/^GTM-[A-Z0-9]+$/i)) return alert('Invalid GTM ID');
      localStorage.setItem('gtm_id', id);
      const script = document.createElement('script');
      script.src = 'https://www.googletagmanager.com/gtm.js?id=' + id;
      script.async = true;
      document.head.appendChild(script);
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.googletagmanager.com/ns.html?id=${id}`;
      iframe.height = 0;
      iframe.width = 0;
      iframe.style.display = 'none';
      iframe.style.visibility = 'hidden';
      document.body.appendChild(iframe);
    }

    function runCustom() {
      try {
        const raw = customEditor.getValue();
        new Function(raw)();
        log('‚úÖ Ran custom JS');
      } catch (e) {
        log('‚ùå Error: ' + e.message);
      }
    }

    function copyCustom() {
      navigator.clipboard.writeText(customEditor.getValue()).then(() => log('üìã Copied custom JS'));
    }

    const defaultPresets = window.gtmPresets || [];

    function loadPresets() {
      const saved = localStorage.getItem('presets_full_js');
      const presets = saved ? JSON.parse(saved) : defaultPresets;
      const container = document.getElementById('presetsArea');
      container.innerHTML = '';
      presets.forEach((preset, i) => container.appendChild(renderPreset(preset, i)));
    }

    function renderPreset(preset, index) {
      const wrapper = document.createElement('div');
      wrapper.className = 'preset-wrapper';

      const buttons = document.createElement('div');
      buttons.className = 'preset-buttons';

      const runBtn = document.createElement('button');
      runBtn.textContent = 'Push';

      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'Copy as dataLayer.push';
      copyBtn.className = 'small-button';

      const copyDLBtn = document.createElement('button');
      copyDLBtn.textContent = 'Copy as datalayer.js block';
      copyDLBtn.className = 'small-button';

      const label = document.createElement('div');
      label.className = 'preset-header';
      label.textContent = 'Event: ' + (preset.name || `custom_${index + 1}`);

      const textarea = document.createElement('textarea');
      textarea.value = preset.code;
      textarea.rows = 8;

      const editor = CodeMirror.fromTextArea(textarea, {
        mode: "javascript",
        theme: "eclipse",
        lineNumbers: true,
        matchBrackets: true
      });

      runBtn.onclick = () => {
        try {
          new Function(editor.getValue())();
          log(`‚úÖ Executed: ${label.textContent}`);
        } catch (e) {
          log('‚ùå Error: ' + e.message);
        }
      };

      copyBtn.onclick = () => {
        navigator.clipboard.writeText(editor.getValue()).then(() => log('üìã Copied as dataLayer.push'));
      };

      copyDLBtn.onclick = () => {
        const name = preset.name || `custom_${index + 1}`;
        const fullBlock = `// --- ${name} START ---
{
  name: "${name}",
  code: \`${editor.getValue()}\`
},
// --- ${name} END ---`;
        navigator.clipboard.writeText(fullBlock).then(() => log('üìã Copied as datalayer.js block'));
      };

      buttons.appendChild(runBtn);
      buttons.appendChild(copyBtn);
      buttons.appendChild(copyDLBtn);

      const container = document.createElement('div');
      container.style.flex = '1';
      container.appendChild(label);
      container.appendChild(editor.getWrapperElement());

      wrapper.appendChild(buttons);
      wrapper.appendChild(container);
      return wrapper;
    }

    function savePresets() {
      const editors = document.querySelectorAll('.CodeMirror');
      const updated = Array.from(editors).map((cm, i) => {
        const name = document.querySelectorAll('.preset-header')[i].textContent.replace('Event: ', '');
        const code = cm.CodeMirror.getValue();
        return { name, code };
      });
      localStorage.setItem('presets_full_js', JSON.stringify(updated));
      log('üíæ Presets saved to localStorage');
      loadPresets();
    }

    function resetPresets() {
      localStorage.removeItem('presets_full_js');
      log('‚ôªÔ∏è LocalStorage cleared. Reloading‚Ä¶');
      loadPresets();
    }

function copyAllAsDataLayer() {
  var editors = document.querySelectorAll('.CodeMirror');
  var names = document.querySelectorAll('.preset-header');
  var blocks = Array.prototype.map.call(editors, function(cm, i) {
    var name = names[i].textContent.replace('Event: ', '');
    var code = cm.CodeMirror.getValue();
    return '// --- ' + name + ' START ---\n' +
      '{\n' +
      '  name: "' + name + '",\n' +
      '  code: `' + code + '`\n' +
      '},\n' +
      '// --- ' + name + ' END ---';
  });

  var full = 'const presetEvents = [\n' + blocks.join('\n\n') + '\n];\n\nwindow.gtmPresets = presetEvents;';
  navigator.clipboard.writeText(full).then(function() {
    log('‚úÖ All events copied as datalayer.js format');
  });
}

window.gtmPresets = presetEvents;`;
      navigator.clipboard.writeText(full).then(() => log('üìã All events copied'));
    }

let customEditor;

window.addEventListener('load', () => {
  const lastId = localStorage.getItem('gtm_id');
  if (lastId) document.getElementById('gtmId').value = lastId;
  loadPresets();
  customEditor = CodeMirror.fromTextArea(document.getElementById('customJson'), {
    mode: "javascript",
    theme: "eclipse",
    lineNumbers: true,
    matchBrackets: true
  });
});
  </script>
</body>
</html>



