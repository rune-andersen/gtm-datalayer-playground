<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GTM Playground</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/javascript/javascript.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
    }

    h1, h2 {
      margin-bottom: 0.5em;
    }

    input[type="text"] {
      width: 250px;
    }

    textarea {
      width: 100%;
      height: 120px;
    }

    .preset-block {
      margin-bottom: 3em;
    }

    .CodeMirror {
      border: 1px solid #ccc;
      height: auto;
      background: #f8f8f8;
      font-size: 14px;
      width: 100%;
    }

    .editor-wrapper {
      margin-top: 0.5em;
    }

    .custom-editor-wrapper {
      max-width: 640px;
    }

    .btn {
      margin: 0.2em 0.5em 0.2em 0;
      padding: 6px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h1>GTM Playground</h1>

<label>Enter your GTM Container ID:</label>
<input type="text" id="gtmIdInput" placeholder="GTM-XXXXXXX">
<button class="btn" onclick="injectGTM()">Inject GTM</button>

<h2>Free custom JS</h2>
<div class="custom-editor-wrapper">
  <button class="btn" onclick="runCustomJS()">Run JS</button>
  <button class="btn" onclick="copyCustomJS()">Copy</button>
  <textarea id="customInput">// Example:
dataLayer.push({
  event: "custom_event",
  my_value: 123
});</textarea>
</div>

<pre id="output" style="border:1px solid #ccc; padding:1em; margin-top:1em;">Console output will appear here…</pre>

<h2>Test Events (editable in <code>datalayer.js</code>)</h2>
<button class="btn" onclick="savePresets()">💾 Save Changes to localStorage</button>
<p>Gem ændringer, så de bevares ved reload.</p>
<button class="btn" onclick="copyAll()">📋 Copy ALL as datalayer.js file</button>
<p>Kopierer alle events i formatet klar til <code>datalayer.js</code>.</p>
<button class="btn" onclick="resetPresets()">🔄 Reset and use datalayer.js</button>
<p>Fjerner gemte events og henter igen fra <code>datalayer.js</code></p>

<div id="presets"></div>

<script src="datalayer.js"></script>
<script>
  const log = (msg) => {
    document.getElementById('output').textContent += msg + '\n';
  };

  const injectGTM = () => {
    const id = document.getElementById('gtmIdInput').value.trim();
    if (!id.startsWith('GTM-')) {
      alert('Please enter a valid GTM Container ID');
      return;
    }
    const script = document.createElement('script');
    script.src = `https://www.googletagmanager.com/gtm.js?id=${id}`;
    document.head.appendChild(script);
    log('✅ GTM injected: ' + id);
  };

  const runCustomJS = () => {
    const code = document.getElementById('customInput').value;
    try {
      new Function(code)();
      log('▶️ Custom JS executed');
    } catch (e) {
      log('❌ Error in custom JS: ' + e.message);
    }
  };

  const copyCustomJS = () => {
    const text = document.getElementById('customInput').value;
    navigator.clipboard.writeText(text).then(() => log('📋 Copied custom JS'));
  };

  const defaultPresets = window.gtmPresets || [];

  let presetEditors = [];

  const renderPresets = () => {
    const container = document.getElementById('presets');
    container.innerHTML = '';
    presetEditors = [];

    defaultPresets.forEach((preset, index) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'preset-block';

      const label = document.createElement('strong');
      label.textContent = 'Event: ' + preset.name;

      const textarea = document.createElement('textarea');
      textarea.value = preset.code;

      const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'javascript',
        lineNumbers: true,
        lineWrapping: true,
        tabSize: 2
      });

      const pushBtn = document.createElement('button');
      pushBtn.className = 'btn';
      pushBtn.textContent = 'Push';
      pushBtn.onclick = () => {
        try {
          new Function(editor.getValue())();
          log('▶️ Ran ' + preset.name);
        } catch (e) {
          log('❌ Error parsing JS: ' + e.message);
        }
      };

      const copyBtn1 = document.createElement('button');
      copyBtn1.className = 'btn';
      copyBtn1.textContent = 'Copy as dataLayer.push';
      copyBtn1.onclick = () => {
        navigator.clipboard.writeText(editor.getValue()).then(() => {
          log('📋 Copied as dataLayer.push');
        });
      };

      const copyBtn2 = document.createElement('button');
      copyBtn2.className = 'btn';
      copyBtn2.textContent = 'Copy as datalayer.js block';
      copyBtn2.onclick = () => {
        const name = preset.name || `custom_${index + 1}`;
        const fullBlock = `/* === START ${name} === */\n{\n  name: "${name}",\n  code: \`${editor.getValue()}\`\n},\n/* === END ${name} === */`;
        navigator.clipboard.writeText(fullBlock).then(() => {
          log('📋 Copied as datalayer.js block');
        });
      };

      wrapper.appendChild(label);
      wrapper.appendChild(document.createElement('br'));
      wrapper.appendChild(pushBtn);
      wrapper.appendChild(copyBtn1);
      wrapper.appendChild(copyBtn2);
      wrapper.appendChild(editor.getWrapperElement());

      container.appendChild(wrapper);
      presetEditors.push(editor);
    });
  };

  const savePresets = () => {
    const updated = presetEditors.map((editor, index) => ({
      name: defaultPresets[index].name || `custom_${index + 1}`,
      code: editor.getValue()
    }));
    localStorage.setItem('presets_full_js', JSON.stringify(updated));
    log('💾 Presets saved to localStorage');
  };

  const loadPresets = () => {
    const raw = localStorage.getItem('presets_full_js');
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        window.gtmPresets = parsed;
        log('📥 Loaded presets from localStorage');
      } catch (e) {
        log('⚠️ Failed to load saved presets: ' + e.message);
      }
    }
    renderPresets();
  };

  const resetPresets = () => {
    localStorage.removeItem('presets_full_js');
    window.gtmPresets = defaultPresets;
    renderPresets();
    log('🔁 Reset to original datalayer.js');
  };

  const copyAll = () => {
    const blocks = presetEditors.map((editor, index) => {
      const name = defaultPresets[index].name || `custom_${index + 1}`;
      return `/* === START ${name} === */\n{\n  name: "${name}",\n  code: \`${editor.getValue()}\`\n},\n/* === END ${name} === */`;
    });
    const finalOutput = `const presetEvents = [\n${blocks.join('\n\n')}\n];\n\nwindow.gtmPresets = presetEvents;`;
    navigator.clipboard.writeText(finalOutput).then(() => {
      log('📋 Copied ALL as datalayer.js');
    });
  };

  loadPresets();
</script>

</body>
</html>


